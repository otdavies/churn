# /churn-push - Push Finalized Branch

Push a finalized churn branch to remote and optionally create a PR.

## When to Use

After `/churn-done` has finalized a branch and you want to:
- Push the clean branch to remote
- Optionally create a pull request

## Prerequisites

- On a finalized branch (not `churn/*`)
- Clean working tree
- Remote configured

## Process

### 1. Validate State

```bash
BRANCH=$(git branch --show-current)

# Should not be on a churn/* branch anymore
if [[ "$BRANCH" == churn/* ]]; then
    echo "Still on churn branch. Run /churn-done first to finalize."
    exit 1
fi

# Should not be on main/master
if [[ "$BRANCH" == "main" || "$BRANCH" == "master" ]]; then
    echo "On main branch. Nothing to push for churn."
    exit 1
fi

# Check for remote
if ! git remote get-url origin &>/dev/null; then
    echo "No remote 'origin' configured."
    exit 1
fi
```

### 2. Push to Remote

```bash
git push -u origin "$BRANCH"
```

Report result:
```
Pushed: feature/jwt-auth → origin/feature/jwt-auth
```

### 3. Offer PR Creation

Use `AskUserQuestion`:
```
Branch pushed successfully!

Would you like to create a pull request?
1. Yes, create PR
2. No, just pushed
```

### 4. Create PR (if requested)

Generate PR description from:
- The finalized commit message
- docs/CHURN_PLAN.md (if exists)
- Working.md churn state

**PR Format:**
```markdown
## Summary

[Brief description from commit message]

## Changes

- [Change 1]
- [Change 2]
- [Change 3]

## Test Plan

- [ ] Build passes
- [ ] Tests pass
- [ ] Manual testing completed

---
Generated by [Churn](https://github.com/...) - N iterations
```

**Create PR:**
```bash
gh pr create \
    --title "[Type]: Brief description" \
    --body "$(cat <<'EOF'
## Summary
...

## Changes
...

## Test Plan
...
EOF
)"
```

### 5. Report Success

```
Pull Request created!

PR: https://github.com/owner/repo/pull/123
Title: feat: Implement JWT authentication
Branch: feature/jwt-auth → main

Next steps:
- Review the PR
- Request reviewers
- Merge when approved
```

## Error Handling

**Push rejected (needs pull):**
```
Push rejected: remote has changes.

Options:
1. git pull --rebase origin [branch] && git push
2. git push --force-with-lease (if you're sure)
```

**No gh CLI:**
```
GitHub CLI (gh) not installed.
Push succeeded, but cannot create PR automatically.

Create PR manually: https://github.com/owner/repo/compare/[branch]
```

**Auth issues:**
```
Not authenticated with GitHub.
Run: gh auth login
```

## When to Use Force Push

**Safe cases:**
- First push of a new branch (nothing to overwrite)
- After rebasing a branch no one else is using
- After amending commits on your own branch

**Use --force-with-lease:**
```bash
git push --force-with-lease origin "$BRANCH"
```
This fails if someone else pushed in the meantime (safer than --force).

**Never force push:**
- To main/master
- To shared branches others are working on

## Important Notes

- Always use `-u` flag on first push to set upstream
- PR creation requires `gh` CLI to be installed and authenticated
- If PR template exists in repo, it will be used
- Consider adding reviewers automatically if team configured
